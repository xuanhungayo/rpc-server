/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/* 
 * File:   client.cpp
 * Author: cpu10170-local
 *
 * Created on July 18, 2017, 1:49 PM
 */

#include <stdlib.h>
#include <iostream>
#include <memory>
#include <thread>

#include "Socket.h"
#include "Protocol.h"

#define CLIENT_NUM 10
#define REQ_PER_CLIENT 100

/*
 * Simple C++ Test Suite
 */

using namespace tcpserver;

void aClient() {
	std::shared_ptr<Socket> client(new Socket("localhost", 3000));
	client->open();
	Protocol protocol(client);
	
	//std::this_thread::sleep_for(std::chrono::duration<int, std::ratio<1>>(rand() % 5));
	for(int i = 0; i < REQ_PER_CLIENT; i++) {
		char type = rand()% 3;
		int key = rand() % 100;
		
		protocol.writeType(type);
		switch (type) {
		case 0: {
			protocol.writeI32(key);
			
			int32_t response;
			protocol.readI32(response);
			if (response == key) std::cout << "GET SUCCESS\n";
			else std::cout << "GET FAIL\n";
			break;
		}
		case 1: {
			protocol.writeI32(key);
			protocol.writeI32(key);
			
			bool response;
			protocol.readBool(response);
			if (response == key % 2) std::cout << "SET SUCCESS\n";
			else std::cout << "SET FAIL\n";
			break;
		}
		case 2: {
			protocol.writeI32(key);
			
			bool response;
			protocol.readBool(response);
			if (response == key % 2) std::cout << "REMOVE SUCCESS\n";
			else std::cout << "REMOVE FAIL\n";
			break;
		}
		}
	}
		
	client->close();
}

int main(int argc, char** argv) {
	srand(time(NULL));
	std::thread clients[CLIENT_NUM];
	time_t begin = clock();
	for (int i = 0; i < CLIENT_NUM; i++) clients[i] = std::thread(aClient);
	for (auto& client : clients) client.join();
	time_t end = clock();
	double time = double(end - begin) / CLOCKS_PER_SEC;

	std::cout << "--Performance: " << int(CLIENT_NUM * REQ_PER_CLIENT / time) << " requests per second\n";
	return 0;
}


